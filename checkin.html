<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTL 4.5 - Check-In</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy: #0f2942;
            --ocean: #1e4d7b;
            --sky: #5b9bd5;
            --sand: #f7e7ce;
            --gold: #d4a574;
            --white: #ffffff;
            --light-gray: #f5f7fa;
            --text: #2c3e50;
            --success: #27ae60;
            --error: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: linear-gradient(135deg, var(--sand) 0%, var(--light-gray) 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            background: linear-gradient(135deg, var(--navy) 0%, var(--ocean) 100%);
            color: white;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: wave 15s infinite linear;
        }

        @keyframes wave {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header-content {
            position: relative;
            z-index: 2;
            padding: 1.5rem 1rem;
        }

        .ship-icon {
            font-size: 3rem;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            margin: 0.3rem 0;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 600;
        }

        .header .session-time {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 0.3rem;
        }

        .header .location {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 0.5rem;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 1.5rem 1rem;
            flex: 1;
        }

        .welcome-box {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            text-align: center;
        }

        .welcome-box h2 {
            font-family: 'Playfair Display', serif;
            color: var(--navy);
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .welcome-box p {
            color: #666;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: var(--navy);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--sky);
        }

        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, var(--ocean) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(15, 41, 66, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(15, 41, 66, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }

        .status-message {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            font-weight: 600;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .success-screen {
            display: none;
            text-align: center;
            background: white;
            border-radius: 16px;
            padding: 2rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .success-screen .checkmark {
            font-size: 4rem;
            margin-bottom: 0.5rem;
        }

        .success-screen h2 {
            font-family: 'Playfair Display', serif;
            color: var(--success);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .success-screen .name-display {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--navy);
            margin: 0.5rem 0;
        }

        .success-screen .session-display {
            background: var(--light-gray);
            border-radius: 10px;
            padding: 0.75rem;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        .door-prize-note {
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .confetti-line {
            font-size: 1.5rem;
            margin-top: 1rem;
        }

        /* Walk-in form (arrival only) */
        .walkin-form {
            display: none;
            background: #fff3cd;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            border: 1px solid #ffc107;
        }

        .walkin-form h3 {
            color: var(--navy);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        /* Admin panel */
        .admin-toggle {
            text-align: center;
            margin-top: 2rem;
        }

        .admin-toggle button {
            background: none;
            border: none;
            color: #999;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: inherit;
        }

        .admin-panel {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .admin-panel h3 {
            font-family: 'Playfair Display', serif;
            color: var(--navy);
            margin-bottom: 1rem;
            text-align: center;
        }

        .admin-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-box {
            flex: 1;
            background: var(--light-gray);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .stat-num {
            font-size: 2rem;
            font-weight: 900;
            color: var(--navy);
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            font-weight: 600;
        }

        .admin-btn {
            width: 100%;
            padding: 0.7rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            margin-bottom: 0.5rem;
            color: white;
        }

        .btn-refresh { background: var(--sky); }
        .btn-roster { background: var(--ocean); }
        .btn-prize { background: var(--gold); color: var(--navy); }

        .roster-area {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
            font-size: 0.85rem;
            display: none;
        }

        .roster-area table {
            width: 100%;
            border-collapse: collapse;
        }

        .roster-area th, .roster-area td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        .roster-area th {
            background: var(--light-gray);
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .prize-winner {
            display: none;
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fff3cd, #ffeeba);
            border-radius: 12px;
            margin-top: 1rem;
        }

        .winner-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--navy);
            margin-top: 0.5rem;
        }

        .winners-so-far {
            display: none;
            background: var(--light-gray);
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            text-align: left;
        }

        .winners-so-far h4 {
            margin-bottom: 0.5rem;
        }

        .footer {
            width: 100%;
            text-align: center;
            padding: 1rem;
            margin-top: auto;
        }

        .footer a {
            color: var(--ocean);
            text-decoration: none;
            font-weight: 600;
        }

        .copy-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- ============================================ -->
    <!-- HEADER - changes based on mode               -->
    <!-- ============================================ -->
    <div class="header">
        <div class="header-content">
            <span class="ship-icon">‚õµ</span>
            <h1>VOYAGE TO LEARNING 4.5</h1>
            <div class="subtitle" id="headerSubtitle">Arrival Check-In</div>
            <div class="session-time" id="headerSessionTime" style="display:none;"></div>
            <div class="location">üìç Oglethorpe County Middle School &bull; February 20, 2026</div>
        </div>
    </div>

    <div class="container">

        <!-- ============================================ -->
        <!-- WELCOME BOX                                  -->
        <!-- ============================================ -->
        <div class="welcome-box" id="welcomeBox">
            <h2>‚öì Welcome Aboard!</h2>
            <p id="welcomeText">Check in to confirm your attendance and be entered for door prizes!</p>
        </div>

        <!-- ============================================ -->
        <!-- EMAIL FORM                                    -->
        <!-- ============================================ -->
        <div id="emailForm">
            <div class="form-group">
                <label>Email Address *</label>
                <input type="email" id="emailInput" placeholder="Enter the email you used to register for VTL" 
                       onkeypress="if(event.key==='Enter') handleLookup()">
            </div>
            <button class="btn btn-primary" id="lookupBtn" onclick="handleLookup()">
                üö¢ Check In
            </button>
        </div>

        <!-- STATUS MESSAGE -->
        <div class="status-message" id="statusMessage"></div>

        <!-- ============================================ -->
        <!-- WALK-IN FORM (Arrival mode only)              -->
        <!-- ============================================ -->
        <div class="walkin-form" id="walkinForm">
            <h3>üëã Welcome, visitor! We don't have a registration for that email. Enter your info below to check in.</h3>
            <div class="form-group">
                <label>Your Name *</label>
                <input type="text" id="walkinName" placeholder="First and Last Name">
            </div>
            <div class="form-group">
                <label>School / Organization</label>
                <select id="walkinSchool">
                    <option value="">-- Select --</option>
                    <option>Oglethorpe County Primary School</option>
                    <option>Oglethorpe County Elementary School</option>
                    <option>Oglethorpe County Middle/High School</option>
                    <option>Central Office</option>
                    <option>NEGA RESA</option>
                    <option>Other</option>
                </select>
            </div>
            <button class="btn btn-primary" id="walkinBtn" onclick="handleWalkinCheckIn()">
                üö¢ Complete Check-In
            </button>
        </div>

        <!-- ============================================ -->
        <!-- SUCCESS SCREEN                                -->
        <!-- ============================================ -->
        <div class="success-screen" id="successScreen">
            <div class="checkmark">üéâ</div>
            <h2 id="successTitle">You're Checked In!</h2>
            <div class="name-display" id="successName"></div>
            <div class="session-display" id="successSession" style="display:none;"></div>
            <!-- Door prize note - arrival only -->
            <div class="door-prize-note" id="doorPrizeNote" style="display:none;">
                üéÅ <strong>Door Prizes:</strong> Winners will be notified by email during the 4th session. Pick up your prize in the cafeteria on your way out. You must be present to win!
            </div>
            <div class="confetti-line">üéä ‚õµ üéä ‚õµ üéä</div>
        </div>

        <!-- ============================================ -->
        <!-- ADMIN PANEL (arrival mode only)               -->
        <!-- ============================================ -->
        <div id="adminSection">
            <div class="admin-toggle">
                <button onclick="toggleAdmin()">üîí Admin</button>
            </div>

            <div class="admin-panel" id="adminPanel">
                <h3>üìä Check-In Dashboard</h3>

                <div class="admin-stats">
                    <div class="stat-box">
                        <span class="stat-num" id="totalCheckedIn">0</span>
                        <span class="stat-label">Checked In</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-num" id="totalRegistered">0</span>
                        <span class="stat-label">Total Registered</span>
                    </div>
                </div>

                <button class="admin-btn btn-refresh" onclick="loadAdminData()">üîÑ Refresh</button>
                <button class="admin-btn btn-roster" onclick="showRoster()">üìã View Check-In Roster</button>
                <button class="admin-btn btn-roster" onclick="copyRoster()">üìÑ Copy Names for Door Prizes</button>
                <button class="admin-btn btn-prize" onclick="drawWinner()">üéÅ Draw Random Door Prize Winner</button>
                <button class="admin-btn" style="background:#aaa;" onclick="resetWinners()">üîÑ Reset Winners (Start Over)</button>

                <div class="roster-area" id="rosterArea"></div>
                <div class="prize-winner" id="prizeWinner">
                    <div style="font-size:2.5rem;">üèÜ</div>
                    <div>The winner is...</div>
                    <div class="winner-name" id="winnerName"></div>
                    <div style="font-size:1.5rem; margin-top:0.5rem;">üéäüéâüéä</div>
                </div>
                <div class="winners-so-far" id="winnersSoFar">
                    <h4>üéÅ Winners So Far:</h4>
                    <div id="winnersListDisplay"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <a href="https://ssynan-oss.github.io/voyage-to-learning/">‚Üê Back to Session Registration</a>
    </div>

    <div class="copy-toast" id="copyToast">‚úÖ Names copied to clipboard!</div>

    <script>
        // ============================================
        // AIRTABLE CONFIGURATION
        // ============================================
        const AIRTABLE_CONFIG = {
            apiKey: 'pat4JfPWUNgr4NQxL.342aa5b23a4784cc789d0a9729b0c52cae067201249a0188661ced3b247571a7',
            baseId: 'appGVgzw2GnMh3gii'
        };

        // ============================================
        // DETECT MODE: SESSION or ARRIVAL
        // ============================================
        const urlParams = new URLSearchParams(window.location.search);
        const sessionNum = urlParams.get('session');
        const isSessionMode = sessionNum && ['1','2','3','4'].includes(sessionNum);

        const SESSION_TIMES = {
            '1': '8:15 ‚Äì 9:05',
            '2': '9:20 ‚Äì 10:10',
            '3': '10:35 ‚Äì 11:25',
            '4': '11:40 ‚Äì 12:30'
        };

        // ============================================
        // SET UP UI BASED ON MODE
        // ============================================
        if (isSessionMode) {
            // SESSION ATTENDANCE MODE
            document.getElementById('headerSubtitle').textContent = 'Session ' + sessionNum + ' Attendance';
            document.getElementById('headerSessionTime').textContent = SESSION_TIMES[sessionNum];
            document.getElementById('headerSessionTime').style.display = 'block';
            document.getElementById('welcomeText').textContent = 'Scan to check in for attendance. Enter the email you used to register for VTL.';
            document.getElementById('welcomeBox').querySelector('h2').textContent = 'üìã Session ' + sessionNum + ' Check-In';
            // Hide admin section for session mode
            document.getElementById('adminSection').style.display = 'none';
        } else {
            // ARRIVAL / DOOR PRIZE MODE
            document.getElementById('headerSubtitle').textContent = 'Arrival Check-In';
            document.getElementById('welcomeText').textContent = 'Check in to confirm your attendance and be entered for door prizes!';
        }

        // ============================================
        // SHARED: Airtable fetch helper
        // ============================================
        async function airtableFetch(table, options = {}) {
            let url = `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${encodeURIComponent(table)}`;
            if (options.query) url += '?' + options.query;
            
            const fetchOptions = {
                headers: {
                    'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                    'Content-Type': 'application/json'
                }
            };

            if (options.method) fetchOptions.method = options.method;
            if (options.body) fetchOptions.body = JSON.stringify(options.body);

            const response = await fetch(url, fetchOptions);
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`Airtable error: ${response.status} - ${errText}`);
            }
            return response.json();
        }

        // ============================================
        // MAIN LOOKUP HANDLER
        // ============================================
        async function handleLookup() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            if (!email || !email.includes('@')) {
                showStatus('Please enter a valid email address.', 'error');
                return;
            }

            const btn = document.getElementById('lookupBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Looking you up...';

            try {
                if (isSessionMode) {
                    await handleSessionCheckIn(email);
                } else {
                    await handleArrivalCheckIn(email);
                }
            } catch (err) {
                console.error(err);
                showStatus('Something went wrong. Please try again. (' + err.message + ')', 'error');
                btn.disabled = false;
                btn.innerHTML = 'üö¢ Check In';
            }
        }

        // ============================================
        // SESSION ATTENDANCE CHECK-IN
        // Looks up email in Registrations table
        // Writes timestamp to Attended1/2/3/4
        // ============================================
        async function handleSessionCheckIn(email) {
            const btn = document.getElementById('lookupBtn');
            const fieldName = 'Attended' + sessionNum;

            // Search Registrations table for this email
            const formula = encodeURIComponent(`LOWER({Email})="${email}"`);
            const data = await airtableFetch('Registrations', {
                query: `filterByFormula=${formula}`
            });

            if (data.records.length === 0) {
                showStatus('Email not found. Please use the email you registered with for VTL.', 'error');
                btn.disabled = false;
                btn.innerHTML = 'üö¢ Check In';
                return;
            }

            const record = data.records[0];
            const name = record.fields.Name || record.fields.FirstName || 'Attendee';

            // Check if already checked in for this session
            if (record.fields[fieldName]) {
                showStatus(`You're already checked in for Session ${sessionNum}, ${name}! ‚úÖ`, 'info');
                btn.disabled = false;
                btn.innerHTML = 'üö¢ Check In';
                return;
            }

            // Write attendance timestamp
            await airtableFetch('Registrations', {
                method: 'PATCH',
                body: {
                    records: [{
                        id: record.id,
                        fields: {
                            [fieldName]: new Date().toISOString()
                        }
                    }]
                }
            });

            // Show success
            const sessionTitle = record.fields['Session' + sessionNum] || '';
            document.getElementById('successName').textContent = name;
            document.getElementById('successTitle').textContent = "You're Checked In!";
            
            if (sessionTitle && sessionTitle !== 'Presenting') {
                document.getElementById('successSession').textContent = `Session ${sessionNum}: ${sessionTitle}`;
                document.getElementById('successSession').style.display = 'block';
            } else if (sessionTitle === 'Presenting') {
                document.getElementById('successSession').textContent = `Session ${sessionNum}: Presenting`;
                document.getElementById('successSession').style.display = 'block';
            }

            // Hide form, show success (no door prize note for session mode)
            document.getElementById('emailForm').style.display = 'none';
            document.getElementById('welcomeBox').style.display = 'none';
            document.getElementById('doorPrizeNote').style.display = 'none';
            document.getElementById('successScreen').style.display = 'block';
            hideStatus();
        }

        // ============================================
        // ARRIVAL CHECK-IN (Door Prizes)
        // Looks up email in Registrations table
        // If found: marks CheckedIn, also writes to CheckIn table
        // If not found: shows walk-in form
        // ============================================
        let arrivalRecordId = null;
        let arrivalEmail = '';

        async function handleArrivalCheckIn(email) {
            const btn = document.getElementById('lookupBtn');
            arrivalEmail = email;

            // First check if already in CheckIn table
            const checkFormula = encodeURIComponent(`LOWER({Email})="${email}"`);
            const checkData = await airtableFetch('CheckIn', {
                query: `filterByFormula=${checkFormula}`
            });

            if (checkData.records.length > 0) {
                const existingName = (checkData.records[0].fields.FirstName || '') + ' ' + (checkData.records[0].fields.LastName || '');
                showStatus(`You're already checked in, ${existingName.trim()}! You're all set for door prizes. üéâ`, 'info');
                btn.disabled = false;
                btn.innerHTML = 'üö¢ Check In';
                return;
            }

            // Look up in Registrations
            const regFormula = encodeURIComponent(`LOWER({Email})="${email}"`);
            const regData = await airtableFetch('Registrations', {
                query: `filterByFormula=${regFormula}`
            });

            if (regData.records.length > 0) {
                // Found - registered attendee
                const record = regData.records[0];
                const name = record.fields.Name || '';
                const school = record.fields.School || '';
                arrivalRecordId = record.id;

                // Parse name into first/last
                const nameParts = name.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // Write to CheckIn table
                await airtableFetch('CheckIn', {
                    method: 'POST',
                    body: {
                        records: [{
                            fields: {
                                FirstName: firstName,
                                LastName: lastName,
                                Email: email,
                                School: school,
                                CheckInTime: new Date().toISOString()
                            }
                        }]
                    }
                });

                // Mark CheckedIn on Registrations if field exists
                try {
                    await airtableFetch('Registrations', {
                        method: 'PATCH',
                        body: {
                            records: [{
                                id: record.id,
                                fields: { CheckedIn: true }
                            }]
                        }
                    });
                } catch(e) {
                    // CheckedIn field may not exist, that's okay
                    console.log('CheckedIn field not found, skipping:', e.message);
                }

                // Show success with door prize note
                document.getElementById('successName').textContent = name;
                document.getElementById('successTitle').textContent = "You're Checked In!";
                document.getElementById('doorPrizeNote').style.display = 'block';
                document.getElementById('emailForm').style.display = 'none';
                document.getElementById('welcomeBox').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';
                hideStatus();

            } else {
                // Not found - show walk-in form
                document.getElementById('walkinForm').style.display = 'block';
                showStatus('', '');
                btn.disabled = false;
                btn.innerHTML = 'üö¢ Check In';
            }
        }

        // ============================================
        // WALK-IN CHECK-IN (Arrival mode only)
        // ============================================
        async function handleWalkinCheckIn() {
            const name = document.getElementById('walkinName').value.trim();
            const school = document.getElementById('walkinSchool').value;
            const email = arrivalEmail;

            if (!name) {
                showStatus('Please enter your name.', 'error');
                return;
            }

            const btn = document.getElementById('walkinBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Checking in...';

            try {
                const nameParts = name.split(' ');
                const firstName = nameParts[0] || '';
                const lastName = nameParts.slice(1).join(' ') || '';

                // Write to CheckIn table
                await airtableFetch('CheckIn', {
                    method: 'POST',
                    body: {
                        records: [{
                            fields: {
                                FirstName: firstName,
                                LastName: lastName,
                                Email: email,
                                School: school,
                                CheckInTime: new Date().toISOString()
                            }
                        }]
                    }
                });

                // Show success
                document.getElementById('successName').textContent = name;
                document.getElementById('successTitle').textContent = "You're Checked In!";
                document.getElementById('doorPrizeNote').style.display = 'block';
                document.getElementById('emailForm').style.display = 'none';
                document.getElementById('welcomeBox').style.display = 'none';
                document.getElementById('walkinForm').style.display = 'none';
                document.getElementById('successScreen').style.display = 'block';
                hideStatus();

            } catch (err) {
                console.error(err);
                showStatus('Something went wrong. Please try again.', 'error');
                btn.disabled = false;
                btn.innerHTML = 'üö¢ Complete Check-In';
            }
        }

        // ============================================
        // STATUS HELPERS
        // ============================================
        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            if (!msg) { el.style.display = 'none'; return; }
            el.textContent = msg;
            el.className = 'status-message status-' + type;
            el.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        // ============================================
        // ADMIN PANEL (arrival mode only)
        // ============================================
        let allCheckedIn = [];
        let previousWinners = JSON.parse(localStorage.getItem('vtlWinners') || '[]');

        function toggleAdmin() {
            const pwd = prompt('Enter admin password:');
            if (pwd === 'vtl2026') {
                document.getElementById('adminPanel').style.display = 'block';
                loadAdminData();
                updateWinnersDisplay();
            }
        }

        async function loadAdminData() {
            try {
                // Get check-in count
                const checkInData = await airtableFetch('CheckIn', {
                    query: 'fields%5B%5D=FirstName&fields%5B%5D=LastName&fields%5B%5D=Email&fields%5B%5D=School&fields%5B%5D=CheckInTime'
                });
                
                allCheckedIn = checkInData.records.filter(r => r.fields.FirstName || r.fields.LastName);
                document.getElementById('totalCheckedIn').textContent = allCheckedIn.length;

                // Get total registrations
                const regData = await airtableFetch('Registrations', {
                    query: 'fields%5B%5D=Name'
                });
                const totalReg = regData.records.filter(r => r.fields.Name).length;
                document.getElementById('totalRegistered').textContent = totalReg;

            } catch (err) {
                console.error('Admin data error:', err);
            }
        }

        function showRoster() {
            const area = document.getElementById('rosterArea');
            if (allCheckedIn.length === 0) {
                area.innerHTML = '<p>No check-ins yet.</p>';
                area.style.display = 'block';
                return;
            }

            let html = '<table><tr><th>#</th><th>Name</th><th>School</th></tr>';
            allCheckedIn.forEach((r, i) => {
                const name = ((r.fields.FirstName || '') + ' ' + (r.fields.LastName || '')).trim();
                html += `<tr><td>${i+1}</td><td>${name}</td><td>${r.fields.School || ''}</td></tr>`;
            });
            html += '</table>';
            area.innerHTML = html;
            area.style.display = 'block';
        }

        function copyRoster() {
            const names = allCheckedIn.map(r => 
                ((r.fields.FirstName || '') + ' ' + (r.fields.LastName || '')).trim()
            ).filter(n => n).join('\n');
            
            navigator.clipboard.writeText(names).then(() => {
                const toast = document.getElementById('copyToast');
                toast.style.display = 'block';
                setTimeout(() => toast.style.display = 'none', 2500);
            });
        }

        function drawWinner() {
            if (allCheckedIn.length === 0) {
                alert('No one has checked in yet!');
                return;
            }

            // Filter out previous winners
            const eligible = allCheckedIn.filter(r => {
                const name = ((r.fields.FirstName || '') + ' ' + (r.fields.LastName || '')).trim();
                return !previousWinners.includes(name);
            });

            if (eligible.length === 0) {
                alert('Everyone has already won! Click "Reset Winners" to start over.');
                return;
            }

            const winner = eligible[Math.floor(Math.random() * eligible.length)];
            const winnerName = ((winner.fields.FirstName || '') + ' ' + (winner.fields.LastName || '')).trim();

            previousWinners.push(winnerName);
            localStorage.setItem('vtlWinners', JSON.stringify(previousWinners));

            document.getElementById('winnerName').textContent = winnerName;
            document.getElementById('prizeWinner').style.display = 'block';
            updateWinnersDisplay();
        }

        function resetWinners() {
            if (confirm('Reset all winners and start over?')) {
                previousWinners = [];
                localStorage.setItem('vtlWinners', '[]');
                document.getElementById('prizeWinner').style.display = 'none';
                updateWinnersDisplay();
            }
        }

        function updateWinnersDisplay() {
            const container = document.getElementById('winnersSoFar');
            const list = document.getElementById('winnersListDisplay');
            if (previousWinners.length > 0) {
                list.innerHTML = previousWinners.map((n, i) => `${i+1}. ${n}`).join('<br>');
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
    </script>
</body>
</html>
